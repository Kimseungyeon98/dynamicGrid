<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ê¶Œí•œ ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .form-group { margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        select { padding: 8px; width: 100%; max-width: 300px; }

        .column-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; border: 1px solid #eee; padding: 15px; max-height: 400px; overflow-y: auto; }
        .column-item { padding: 5px; border-bottom: 1px solid #f9f9f9; }
        .column-item:hover { background-color: #f1f1f1; }

        .btn { padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; font-size: 16px; }
        .btn:hover { background-color: #0056b3; }
        .btn-disabled { background-color: #ccc; cursor: not-allowed; }

        .header-info { margin-bottom: 20px; padding: 10px; background: #e9ecef; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ”’ ê¶Œí•œë³„ ì»¬ëŸ¼ ì ‘ê·¼ ì œì–´</h2>

    <div class="header-info">
        ì ‘ì†ì: <strong th:text="${#authentication.name}">Admin</strong>
        (<span id="myRole" th:text="${#authentication.authorities[0].authority}">ROLE_ADMIN</span>)
        <a href="/" style="float: right;">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div class="card">
        <div class="form-group">
            <label for="roleSelect">ì„¤ì •í•  ëŒ€ìƒ ê¶Œí•œ ì„ íƒ:</label>
            <select id="roleSelect">
                <option value="">-- ê¶Œí•œì„ ì„ íƒí•˜ì„¸ìš” --</option>
                <option th:each="role : ${roles}" th:value="${role}" th:text="${role}"></option>
            </select>
        </div>

        <div class="form-group">
            <label>ë³´ì—¬ì¤„ ì»¬ëŸ¼ ì„ íƒ (ì²´í¬ = ë³´ì„ / í•´ì œ = ìˆ¨ê¹€)</label>
            <div id="columnList" class="column-list">
                <div th:each="col : ${gridContext.columnDefs}" class="column-item">
                    <label style="font-weight: normal; cursor: pointer;">
                        <input type="checkbox" class="col-check" th:value="${col.field}">
                        <span th:text="${col.header}">ì»¬ëŸ¼ëª…</span>
                        <span style="color: #888; font-size: 0.8em;" th:text="'(' + ${col.field} + ')'"></span>
                    </label>
                </div>
            </div>
        </div>

        <div style="text-align: right;">
            <button id="saveBtn" class="btn" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
        </div>
    </div>
</div>

<script>
    const roleSelect = document.getElementById('roleSelect');
    const myRole = document.getElementById('myRole').innerText;
    const checkBoxes = document.querySelectorAll('.col-check');

    // ê¶Œí•œ ë³€ê²½ ì‹œ ì„œë²„ì—ì„œ í•´ë‹¹ ê¶Œí•œì˜ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    roleSelect.addEventListener('change', async function() {
        const targetRole = this.value;
        if (!targetRole) return;

        // [UI ë°©ì–´ ë¡œì§] ë‹´ë‹¹ì(MANAGER)ëŠ” ê´€ë¦¬ì(ADMIN)ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŒ
        if (myRole === 'ROLE_MANAGER' && targetRole === 'ROLE_ADMIN') {
            alert("ë‹´ë‹¹ìëŠ” ê´€ë¦¬ì ê¶Œí•œì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            this.value = ""; // ì„ íƒ ì·¨ì†Œ
            return;
        }

        try {
            // API í˜¸ì¶œ: ì„ íƒëœ ë¡¤ì´ í˜„ì¬ 'ë³¼ ìˆ˜ ìˆëŠ”' ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const response = await fetch(`/admin/api/config/${targetRole}`);
            const visibleColumns = await response.json();

            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            checkBoxes.forEach(cb => {
                // ê°€ì ¸ì˜¨ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì²´í¬, ì—†ìœ¼ë©´ í•´ì œ
                cb.checked = visibleColumns.includes(cb.value);
            });
        } catch (err) {
            console.error(err);
            alert("ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });

    // ì €ì¥ ë¡œì§
    async function saveConfig() {
        const targetRole = roleSelect.value;
        if (!targetRole) {
            alert("ì„¤ì •í•  ê¶Œí•œì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        // ì²´í¬ëœ ì»¬ëŸ¼ë“¤ë§Œ ìˆ˜ì§‘
        const visibleCols = [];
        checkBoxes.forEach(cb => {
            if (cb.checked) visibleCols.push(cb.value);
        });

        // ì „ì†¡ ë°ì´í„° ìƒì„±
        const data = {
            gridCode: "FACILITY_ASSET_GRID",
            targetRoleName: targetRole,
            visibleColumns: visibleCols
        };

        try {
            const res = await fetch('/admin/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! \ní•´ë‹¹ ì‚¬ìš©ìê°€ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì ìš©ë©ë‹ˆë‹¤.");
            } else {
                const errMsg = await res.text();
                alert("ì €ì¥ ì‹¤íŒ¨: " + errMsg);
            }
        } catch (err) {
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }
</script>
</body>
</html>