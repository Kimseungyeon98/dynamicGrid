<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ì‹œì„¤ ê´€ë¦¬ ëŒ€ì¥</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #eee; }
        .hidden-col { display: none; }
        .control-panel { background: #f4f4f4; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .control-panel label { margin-right: 15px; display: inline-block; }
    </style>
</head>
<body>

<h2>ğŸ¢ ì‹œì„¤ ìì‚° ê´€ë¦¬ ëŒ€ì¥</h2>
<div style="margin-bottom: 10px;">
    í˜„ì¬ ì ‘ì†ì ê¶Œí•œ: <span th:text="${#authentication != null ? #authentication.name : 'Anonymous'}"></span>
    (<span th:text="${#authentication != null ? #authentication.authorities : 'None'}"></span>)
    <a href="/logout" style="margin-left: 10px; color: red;">ë¡œê·¸ì•„ì›ƒ</a>
</div>

<div class="control-panel" id="columnControls">
    <strong>ğŸ‘ï¸ í‘œì‹œ ì„¤ì •: </strong>
</div>

<table id="dataTable">
    <thead><tr id="tableHead"></tr></thead>
    <tbody id="tableBody"></tbody>
</table>

<script th:inline="javascript">
    /* [ì£¼ì˜] Thymeleaf íŒŒì‹± ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ CDATA ì£¼ì„ ì²˜ë¦¬
       ë˜ëŠ” unescaped text ì‚¬ìš©
    */

    // Controllerì—ì„œ Stringìœ¼ë¡œ ë³´ëƒˆë‹¤ë©´ JSON.parse í•„ìš”
    // (ë§Œì•½ Controllerì—ì„œ ê°ì²´(List/Map) ìì²´ë¥¼ ë³´ëƒˆë‹¤ë©´ JSON.parse ì œê±°í•´ì•¼ í•¨)
    const tableData = JSON.parse([[${tableDataJson}]]);
    const allowedColumns = JSON.parse([[${allowedColumnsJson}]]);
    const hiddenColumns = JSON.parse([[${hiddenColumnsJson}]]);

    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const columnControls = document.getElementById('columnControls');

    function init() {
        renderControls();
        renderTable();
    }

    function renderControls() {
        allowedColumns.forEach(col => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');

            // [ìˆ˜ì • 2] ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„±í•˜ëŠ” íƒœê·¸ëŠ” ìƒê´€ì—†ìœ¼ë‚˜,
            // í˜¹ì‹œ ëª¨ë¥´ë‹ˆ JS ë¡œì§ì€ ê·¸ëŒ€ë¡œ ë‘ .
            checkbox.type = 'checkbox';
            checkbox.value = col;
            checkbox.checked = !hiddenColumns.includes(col);

            checkbox.addEventListener('change', (e) => {
                toggleColumn(col, e.target.checked);
            });

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" " + col));
            columnControls.appendChild(label);
        });
    }

    function renderTable() {
        // í—¤ë”
        allowedColumns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            th.dataset.col = col;
            if (hiddenColumns.includes(col)) th.classList.add('hidden-col');
            tableHead.appendChild(th);
        });

        // ë°”ë””
        tableData.forEach(row => {
            const tr = document.createElement('tr');
            allowedColumns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] !== null ? row[col] : "";
                td.dataset.col = col;
                if (hiddenColumns.includes(col)) td.classList.add('hidden-col');
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    function toggleColumn(colName, isVisible) {
        const cells = document.querySelectorAll(`[data-col="${colName}"]`);
        cells.forEach(cell => {
            if (isVisible) cell.classList.remove('hidden-col');
            else cell.classList.add('hidden-col');
        });
    }

    init();
</script>
</body>
</html>