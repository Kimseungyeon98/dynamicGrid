<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Dynamic Grid System</title>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; }

        /* 레이아웃 */
        .grid-container { display: flex; flex-direction: column; gap: 10px; }

        /* 컨트롤 패널 */
        .control-panel { background: #f8f9fa; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .control-panel h4 { margin: 0 0 10px 0; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; }
        .checkbox-group label { cursor: pointer; }

        /* 테이블 스타일 */
        table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 8px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        th { background-color: #eee; text-align: center; font-weight: bold; }

        /* 숨김 처리 클래스 */
        .user-hidden { display: none; }

        /* 페이지네이션 스타일 */
        .pagination { display: flex; justify-content: center; margin-top: 20px; gap: 5px; }
        .page-btn { padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .page-btn:hover { background: #f0f0f0; }
        .page-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .page-btn:disabled { background: #eee; cursor: not-allowed; }

        /* 헤더 정렬 스타일 */
        th.sortable { cursor: pointer; position: relative; padding-right: 20px; }
        th.sortable:hover { background-color: #e2e6ea; }

        /* 정렬 아이콘 (가상 요소 사용) */
        th.sort-asc::after { content: "▲"; position: absolute; right: 5px; font-size: 10px; }
        th.sort-desc::after { content: "▼"; position: absolute; right: 5px; font-size: 10px; }
    </style>
</head>
<body>

<h2 th:text="${gridContext != null ? gridContext.gridName : '데이터 로드 실패'}">그리드 제목</h2>

<div style="margin-bottom: 15px;">
    사용자: <strong th:text="${#authentication.name}">User</strong>
    (<span th:text="${#authentication.authorities}">Role</span>) |
    <a href="/logout" style="color: red;">로그아웃</a>
</div>

<div class="grid-container">
    <div class="control-panel">
        <div class="control-panel">
            <h4>⚙️ 그리드 제어</h4>

            <div style="margin-bottom: 10px; display: flex; gap: 5px;">
                <input type="text" id="searchInput" placeholder="자산명 또는 모델명 검색..." style="padding: 5px; width: 250px;">
                <button onclick="triggerSearch()" style="padding: 5px 15px; cursor: pointer;">검색</button>
            </div>

            <div id="columnControls" class="checkbox-group"></div>
        </div>
    </div>

    <table id="dataTable">
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="pagination" id="paginationControls"></div>
</div>

<script th:inline="javascript">
    /* [디버깅용 안전장치]
       Thymeleaf 변수가 제대로 넘어오지 않을 경우를 대비해 기본값({}) 처리
    */
    const context = [[${gridContext}]] || {};
    // 데이터가 비어있을 경우 에러 방지
    const columnDefs = context.columnDefs || [];
    const tableData = context.tableData || [];
    const userConfig = context.userConfig || {};
    // 사용자 설정값 추출 (없을 경우 기본값)
    const userHiddenCols = userConfig.hiddenColumns || [];
    const userColWidths = userConfig.columnWidths || {};

    // 페이징 상태 관리 변수
    let currentPage = 0;
    const pageSize = 20; // 한 페이지에 보여줄 개수
    let totalPages = 0;

    // DOM 요소 가져오기
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const paginationControls = document.getElementById('paginationControls');

    // v5.0 [New] 상태 관리 변수 추가
    let currentKeyword = "";
    let currentSortField = "id"; // 기본 정렬 컬럼
    let currentSortDir = "DESC"; // 기본 정렬 방향

    // 초기화 실행
    document.addEventListener('DOMContentLoaded', () => {
        init();
        // [V4.0] 초기 데이터 로드 (페이지 0)
        loadGridData(0);
    });

    function init() {
        renderControls(); // 체크박스 렌더링 (기존 동일)
        renderHeader();   // 헤더 렌더링 (기존 renderTable에서 분리)
    }

    // [New] 서버에서 데이터 가져오기
    async function loadGridData(page) {
        try {
            // 로딩 표시 (선택사항)
            tableBody.innerHTML = '<tr><td colspan="100" style="text-align:center;">데이터 로딩중...</td></tr>';

            // v5.0 URL 생성 (검색어, 정렬 파라미터 추가)
            const params = new URLSearchParams({
                gridCode: "FACILITY_ASSET_GRID",
                page: page,
                size: pageSize,
                keyword: currentKeyword,
                sortField: currentSortField,
                sortDir: currentSortDir
            });

            // v5.0 [수정]
            const response = await fetch(`/api/grid/data?${params.toString()}`);
            const result = await response.json();

            const data = result.content; // 실제 데이터 리스트
            currentPage = result.number;
            totalPages = result.totalPages;

            // 테이블 다시 그리기
            renderBody(data);

            // 페이지네이션 버튼 다시 그리기
            renderPagination();

            // v5.0 [New] 헤더에 현재 정렬 상태 표시 업데이트
            updateHeaderSortUI();

        } catch (err) {
            console.error(err);
            tableBody.innerHTML = '<tr><td colspan="100" style="text-align:center; color:red;">데이터 로드 실패</td></tr>';
        }
    }

    // v5.0 헤더 그리기 (한 번만 실행하면 됨)
    function renderHeader() {
        tableHead.innerHTML = "";
        columnDefs.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col.header;
            th.dataset.col = col.field;
            const width = userColWidths[col.field] || col.width;
            if(width) th.style.width = width + "px";
            if (userHiddenCols.includes(col.field)) th.classList.add('user-hidden');
            tableHead.appendChild(th);
        });
    }

    // v5.0 [New] 정렬 핸들러
    function handleSort(field) {
        if (currentSortField === field) {
            // 같은 컬럼 클릭 시: ASC -> DESC -> 기본(ID DESC) 순환
            if (currentSortDir === "ASC") {
                currentSortDir = "DESC";
            } else {
                // 정렬 초기화 (기본값으로 복귀)
                currentSortField = "id";
                currentSortDir = "DESC";
            }
        } else {
            // 다른 컬럼 클릭 시: 해당 컬럼 ASC로 시작
            currentSortField = field;
            currentSortDir = "ASC";
        }

        loadGridData(currentPage); // 데이터 다시 로드
    }

    // v5.0 [New] 헤더 UI 업데이트 (화살표 표시)
    function updateHeaderSortUI() {
        // 모든 헤더의 정렬 클래스 제거
        const ths = tableHead.querySelectorAll('th');
        ths.forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            // 현재 정렬된 컬럼에만 클래스 추가
            if (th.dataset.col === currentSortField) {
                if (currentSortDir === "ASC") th.classList.add('sort-asc');
                else th.classList.add('sort-desc');
            }
        });
    }

    // v5.0 [New] 검색 버튼 클릭 시 실행
    function triggerSearch() {
        const input = document.getElementById('searchInput');
        currentKeyword = input.value;
        currentPage = 0; // 검색 시 1페이지로 초기화
        loadGridData(0);
    }

    // v5.0 [New] 엔터키 검색 지원
    document.getElementById('searchInput').addEventListener("keypress", function(event) {
        if (event.key === "Enter") triggerSearch();
    });

    // [수정] 헤더 렌더링 (클릭 이벤트 추가)
    function renderHeader() {
        tableHead.innerHTML = "";
        columnDefs.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col.header;
            th.dataset.col = col.field;

            // 너비 설정
            const width = userColWidths[col.field] || col.width;
            if(width) th.style.width = width + "px";

            // 숨김 처리
            if (userHiddenCols.includes(col.field)) th.classList.add('user-hidden');

            // [New] 정렬 기능 추가
            th.classList.add('sortable');
            th.onclick = () => handleSort(col.field); // 클릭 시 정렬 함수 실행

            tableHead.appendChild(th);
        });

        updateHeaderSortUI(); // 초기 UI 상태 반영
    }

    // 바디 그리기 (데이터 바뀔 때마다 실행)
    function renderBody(data) {
        tableBody.innerHTML = ""; // 기존 데이터 삭제

        if (!data || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="100" style="text-align:center;">데이터가 없습니다.</td></tr>';
            return;
        }

        data.forEach(row => {
            const tr = document.createElement('tr');
            columnDefs.forEach(col => {
                const td = document.createElement('td');
                const val = row[col.field];
                td.textContent = (val !== null && val !== undefined) ? val : "";
                td.dataset.col = col.field;
                if(col.align) td.style.textAlign = col.align;
                if (userHiddenCols.includes(col.field)) td.classList.add('user-hidden');
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    // [New] 페이지네이션 버튼 렌더링 (간단한 버전)
    function renderPagination() {
        paginationControls.innerHTML = "";

        // 1. 이전 버튼
        const prevBtn = document.createElement('button');
        prevBtn.textContent = "이전";
        prevBtn.className = "page-btn";
        prevBtn.disabled = currentPage === 0;
        prevBtn.onclick = () => loadGridData(currentPage - 1);
        paginationControls.appendChild(prevBtn);

        // 2. 페이지 번호 (현재 페이지 주변 5개만 표시)
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages - 1, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.textContent = i + 1; // 0부터 시작하므로 +1
            btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            btn.onclick = () => loadGridData(i);
            paginationControls.appendChild(btn);
        }

        // 3. 다음 버튼
        const nextBtn = document.createElement('button');
        nextBtn.textContent = "다음";
        nextBtn.className = "page-btn";
        nextBtn.disabled = currentPage >= totalPages - 1;
        nextBtn.onclick = () => loadGridData(currentPage + 1);
        paginationControls.appendChild(nextBtn);
    }


    // [New] 변경사항이 생기면 서버로 전송하는 함수
    async function saveUserPreference() {
        const hiddenCols = [];
        const checkboxes = document.querySelectorAll('#columnControls input[type="checkbox"]');

        checkboxes.forEach(cb => {
            if (!cb.checked) {
                hiddenCols.push(cb.value);
            }
        });

        const payload = {
            gridCode: "FACILITY_ASSET_GRID",
            hiddenColumns: hiddenCols
        };

        try {
            await fetch('/api/user/config/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            console.log("Auto-saved:", hiddenCols);
        } catch (err) {
            console.error("Save failed:", err);
        }
    }

    // 1. 컨트롤 패널(체크박스) 렌더링
    function renderControls() {
        columnDefs.forEach(col => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');

            checkbox.type = 'checkbox';
            checkbox.value = col.field;
            checkbox.checked = !userHiddenCols.includes(col.field);

            checkbox.addEventListener('change', (e) => {
                toggleColumn(col.field, e.target.checked);
                saveUserPreference();
            });

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode("\u00A0" + col.header));
            columnControls.appendChild(label);
        });
    }

    // 3. UI 토글 로직
    function toggleColumn(field, isVisible) {
        const cells = document.querySelectorAll(`[data-col="${field}"]`);
        cells.forEach(cell => {
            if (isVisible) cell.classList.remove('user-hidden');
            else cell.classList.add('user-hidden');
        });
    }
</script>
</body>
</html>